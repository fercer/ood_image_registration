bootstrap: docker
from: cdgatenbee/valis-wsi:1.2.0

%post
    apt-get update; apt-get install -y git wget

    cd /opt
    git clone https://github.com/MathOnco/valis
    cd valis
    git checkout v1.2.0

    # Patch the feature_detectors.py and feature_matcher.py files according to https://github.com/MathOnco/valis/issues/208#issuecomment-3208212972
    sed -i 's/.numpy()/.cpu().numpy()/g' valis/feature_detectors.py
    sed -i 's/.numpy()/.cpu().numpy()/g' valis/feature_matcher.py
    sed -i '2157a\        else:' valis/registration.py
    sed -i '2158a\            self.non_rigid_reg_kwargs = {}' valis/registration.py

    /root/.local/bin/pip3 uninstall valis-wsi -y
    /root/.local/bin/pip3 install /opt/valis
    /root/.local/bin/pip3 install itk-elastix

    # Clone this repository and get access to the VALIS registration script
    cd /opt
    git clone https://github.com/fercer/ood_image_registration
    cp ood_image_registration/scripts/*.py /opt
    cp ood_image_registration/scripts/*.json /opt
    rm -r ood_image_registration

%runscript
    /root/.local/bin/python /opt/valis_registration.py $@