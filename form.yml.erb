<%-
  require 'json'
  # Get the directory of the current file
  conf_dir = Pathname.new(__dir__)
  
  # Read and parse the JSON file
  preprocessors_json_path = conf_dir.join("scripts/preprocessors.json")
  
  # Default to empty if file is missing (error handling)
  if File.exist?(preprocessors_json_path)
    preprocessor_options = JSON.parse(File.read(preprocessors_json_path))
  else
    preprocessor_options = [["Error: JSON not found", ""]]
  end
-%>

# Batch Connect app configuration file
#
# @note Used to define the submitted cluster, title, description, and
#   hard-coded/user-defined attributes that make up this Batch Connect app.
---

# **MUST** set cluster id here that matches cluster configuration file located
# under /etc/ood/config/clusters.d/*.yml
# @example Use the Owens cluster at Ohio Supercomputer Center
#     cluster: "owens"
cluster: "winter2"

# Define attribute values that aren't meant to be modified by the user within
# the Dashboard form
attributes:
  # Set the corresponding modules that need to be loaded for Jupyter to run
  #
  # @note It is called within the batch job as `module load <modules>` if
  #   defined
  # @example Do not load any modules
  #     modules: ""
  # @example Using default python module
  #     modules: "python"
  # @example Using specific python module
  #     modules: "python/3.5"
  # @example Using combination of modules
  #     modules: "python/3.5 cuda/8.0.44"
  modules: "apptainer"
  partition:
    label: "Partition"
    widget: select
    options:
      - ['compute']
  custom_qos:
    label: "QOS"
    widget: select
    options:
      - ['batch', data-exclusive-option-for-queue-compute: true]
      # - ['test', data-exclusive-option-for-queue-rit-test: true]
    help: |
      Currently, image registration jobs are limited to the compute partition and batch QOS.
  num_cores:
    widget: "number_field"
    label: "Number of cores"
    value: 16
    help: |
      The image registration process has been tested with 16 cores only.
    min: 8
    max: 16
    step: 8
  bc_num_hours:
    label: "Number of hours"
    value: 1
    min: 1
    max: 2
    step: 1
    help: |
      The image registration process usually takes one hour only; however, this depends on the size of the image.
  memtask:
    widget: select
    label: "Memory (in GB)"
    options:
      - ["256GB"]
      - ["512GB"]
    help: |
      The image registration requires at least 256 GB mainly for the image generation step after alignment.
  reference_image:
    widget: "path_selector"
    show_hidden: false
    show_files: true
  reference_preprocessor:
    widget: "select"
    label: "Reference image preprocessor"
    options: <%= preprocessor_options %>
  input_image:
    widget: "path_selector"
    show_hidden: false
    show_files: true
  output_dir:
    widget: "path_selector"
    show_hidden: false
    show_files: false
  temp_dir:
    widget: "path_selector"
    show_hidden: false
    show_files: true
  processing_size:
    widget: select
    label: "Processing size"
    options:
      - ["8196"]
      - ["4096"]
      - ["2048"]
      - ["1024"]
      - ["512"]
    help: |
      Size at which the registration process is applied. The image is resized to have its largest side equal to the selected processing size. Highest registration performance requires at least the 8196 size setting.
  output_codec:
    widget: select
    label: Compression codec
    options:
      - ["jp2k"]
      - ["jpeg"]
      - ["zstd"]
      - ["webp"]
      - ["lzw"]
      - ["ccittfax4"]
      - ["packbits"]
      - ["deflate"]
      - ["none"]
    help: |
      Codec used to compress the output .tif image
  output_codec_quality:
    label: "Compression codec quality"
    value: 100
    min: 1
    max: 100
    step: 1
    help: |
      The quality to be preserver after compressing the image with the selected codec. For loss-less compression set it to 100.

# All of the attributes that make up the Dashboard form (in respective order),
# and made available to the submit configuration file and the template ERB
# files
#
# @note You typically do not need to modify this unless you want to add a new
#   configurable value
# @note If an attribute listed below is hard-coded above in the `attributes`
#   option, then it will not appear in the form page that the user sees in the
#   Dashboard
form:
  - modules
  - partition
  - custom_qos
  - num_cores
  - memtask
  - bc_num_hours
  - bc_email_on_started
  - reference_image
  - reference_preprocessor
  - input_image
  - output_dir
  - temp_dir
  - processing_size
  - output_codec
  - output_codec_quality
