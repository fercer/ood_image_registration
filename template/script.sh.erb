#!/usr/bin/env bash

# Set working directory to home directory
cd "${HOME}"

# Clear any existing XDG_RUNTIME_DIR to avoid warnings from dconf
unset XDG_RUNTIME_DIR

<%- unless context.modules.blank? -%>
# Purge the module environment to avoid conflicts
module purge

# Load the require modules
module load <%= context.modules %>

# List loaded modules
module list
<%- end -%>

# Benchmark info
echo "TIMING - Starting Image Registration at: $(date)"

# Launch the Image Registration job

TEMP_DIR="<%= context.temp_dir %>"
PROCESSING_SIZE="<%= context.processing_size %>"
CODEC="<%= context.output_codec %>"
QUALITY="<%= context.output_codec_quality %>"
OUTPUT_DIR="<%= context.output_dir %>"

if [ ! -d "$OUTPUT_DIR" ]; then
    mkdir -p "${OUTPUT_DIR}"
fi

if [ ! -d "$TEMP_DIR" ]; then
    mkdir -p "${TEMP_DIR}"
fi

# Check if the directory was created successfully or not
if [ ! -d "$TEMP_DIR" ]; then
    echo "Could not create temporary file at ${TEMP_DIR}"
    exit 1
fi

REFERENCE_FILENAME="<%= context.reference_image %>"
INPUT_FILENAME="<%= context.input_image %>"

if [ ! -f "$REFERENCE_FILENAME" ]; then
    echo "Could not find reference image '${REFERENCE_FILENAME}'"
    exit 1
fi

if [ ! -f "$INPUT_FILENAME" ]; then
    echo "Could not find input image '${INPUT_FILENAME}'"
    exit 1
fi

REFERENCE_BASENAME=$(basename "$REFERENCE_FILENAME")
if [[ ${REFERENCE_BASENAME} != *".ome.tif"* ]]; then
    REFERENCE_BASENAME="${REFERENCE_BASENAME%.*}"
else
    REFERENCE_BASENAME="${REFERENCE_BASENAME%.ome.tif*}"
fi

# ----------------- Registration pipeline ------------------------------------------------------------------------------------------

# Use a writable file to store compatible bioformats
BF_FORMAT_F=${TEMP_DIR}/.cache/bf_formats.txt
if [ ! -f "$BF_FORMAT_F" ]; then
    BF_FORMAT_DIR=$(dirname ${BF_FORMAT_F})
    if [ ! -d $BF_FORMAT_DIR ]; then
        mkdir -p $BF_FORMAT_DIR
    fi

    touch $BF_FORMAT_F
fi

# Get the readers and preprocessors for the reference and input images
<%-
require 'json'

image_modes = {
    "reference" => "r",
    "input" => "i"
}

advanced_options_keys = {
    "preprocessor" => "p",
    "reader" => "r"
}
    
context_dict = context.to_h
widget_types = JSON.parse(context.json_bridge)

prefix = "batch_connect_session_context_"

advanced_options = {}

selected_option = ""
widget_arguments = {}

image_modes.each do |img_mode,img_mode_flag|
    advanced_options_keys.each do |opt_key,opt_key_flag|
        selected_option = context_dict["#{img_mode}_image_#{opt_key}".to_sym]
        widget_arguments = widget_types["#{prefix}#{img_mode}_image_#{opt_key}"][selected_option]["widget_arguments"]

        args_list = []

        widget_arguments.each do |arg_key,arg_type|
            arg_key = arg_key.to_s.gsub(prefix, "")
            arg_value = context_dict[arg_key.to_sym]

            if arg_type.include?('bool') 
                if args_list
                    args_list << "#{arg_key.gsub("#{img_mode}_image_#{opt_key}_#{selected_option.downcase}_", "--#{img_mode_flag}#{opt_key_flag}-")}"
                end
            else
                args_list << "#{arg_key.gsub("#{img_mode}_image_#{opt_key}_#{selected_option.downcase}_", "--#{img_mode_flag}#{opt_key_flag}-")} #{arg_value}"
            end
        end

        advanced_options["#{img_mode}_image_#{opt_key}"] = args_list.join(" ")
    end
end
-%>

# Execute registration pipeline ----------------------------------------------------------------
command="singularity run -B ${BF_FORMAT_F}:/root/.local/lib/python3.12/site-packages/valis/data/bf_formats.txt ${VALIS_CONTAINER}\
 -s ${REFERENCE_BASENAME} -t ${TEMP_DIR} -o ${OUTPUT_DIR}\
 -r ${REFERENCE_FILENAME}\
 -i ${INPUT_FILENAME}\
<%- image_modes.each do |img_mode,img_mode_flag| -%>
<%- advanced_options_keys.each do |opt_key,opt_key_flag| -%>
 -<%= img_mode_flag %><%= opt_key_flag %> <%= context_dict["#{img_mode}_image_#{opt_key}".to_sym] %>\
 <%= advanced_options["#{img_mode}_image_#{opt_key}"] %> \
<%- end -%>
<%- end -%>
 -mp ${PROCESSING_SIZE}\
 -c ${CODEC} -cq ${QUALITY}\
 -y"

echo "$command"
eval "$command"

echo "TIMING - Finished Image Registration at: $(date)"
