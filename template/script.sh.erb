#!/usr/bin/env bash

# Set working directory to home directory
cd "${HOME}"

# Clear any existing XDG_RUNTIME_DIR to avoid warnings from dconf
unset XDG_RUNTIME_DIR

<%- unless context.modules.blank? -%>
# Purge the module environment to avoid conflicts
module purge

# Load the require modules
module load <%= context.modules %>

# List loaded modules
module list
<%- end -%>

# Benchmark info
echo "TIMING - Starting Image Registration at: $(date)"

# Launch the Image Registration job

TEMP_DIR="<%= context.temp_dir %>"
PROCESSING_SIZE="<%= context.processing_size %>"
CODEC="<%= context.output_codec %>"
QUALITY="<%= context.output_codec_quality %>"
OUTPUT_DIR="<%= context.output_dir %>"

if [ ! -d "$OUTPUT_DIR" ]; then
    mkdir -p "${OUTPUT_DIR}"
fi

if [ ! -d "$TEMP_DIR" ]; then
    mkdir -p "${TEMP_DIR}"
fi

# Check if the directory was created successfully or not
if [ ! -d "$TEMP_DIR" ]; then
    echo "Could not create temporary file at ${TEMP_DIR}"
    exit 1
fi

REFERENCE_FILENAME="<%= context.reference_image %>"
INPUT_FILENAME="<%= context.input_image %>"

if [ ! -f "$REFERENCE_FILENAME" ]; then
    echo "Could not find reference image '${REFERENCE_FILENAME}'"
    exit 1
fi

if [ ! -f "$INPUT_FILENAME" ]; then
    echo "Could not find input image '${INPUT_FILENAME}'"
    exit 1
fi

REFERENCE_BASENAME=$(basename "$REFERENCE_FILENAME")
if [[ ${REFERENCE_BASENAME} != *".ome.tif"* ]]; then
    REFERENCE_BASENAME="${REFERENCE_BASENAME%.*}"
else
    REFERENCE_BASENAME="${REFERENCE_BASENAME%.ome.tif*}"
fi

# ----------------- Registration pipeline ------------------------------------------------------------------------------------------

# Use a writable file to store compatible bioformats
BF_FORMAT_F=${TEMP_DIR}/.cache/bf_formats.txt
if [ ! -f "$BF_FORMAT_F" ]; then
    BF_FORMAT_DIR=$(dirname ${BF_FORMAT_F})
    if [ ! -d $BF_FORMAT_DIR ]; then
        mkdir -p $BF_FORMAT_DIR
    fi

    touch $BF_FORMAT_F
fi

# Get the readers and preprocessors for the reference and input images
<%-
reference_preprocessor_args = []
reference_reader_args = []
input_preprocessor_args = []
input_reader_args = []

reference_image_preprocessor = "reference_image_preprocessor_#{context.reference_image_preprocessor.downcase}_"
reference_image_reader = "reference_image_preprocessor_#{context.reference_image_reader.downcase}_"
input_image_preprocessor = "input_image_reader_#{context.input_image_preprocessor.downcase}_"
input_image_reader = "input_image_reader_#{context.input_image_reader.downcase}_"

context.to_h.each do |opt, opt_val|
    if opt.start_with?(reference_image_preprocessor)
        reference_preprocessor_args << "#{opt.to_s.gsub(reference_image_preprocessor, "--rp-")} #{opt_val}"
    elsif opt.start_with?(reference_image_reader)
        reference_reader_args << "#{opt.to_s.gsub(reference_image_reader, "--rr-")} #{opt_val}"
    elsif opt.start_with?(input_image_preprocessor)
        input_preprocessor_args << "#{opt.to_s.gsub(input_image_preprocessor, "--ip-")} #{opt_val}"
    elsif opt.start_with?(input_image_reader)
        input_reader_args << "#{opt.to_s.gsub(input_image_reader, "--ir-")} #{opt_val}"
    end
end

reference_preprocessor_args = reference_preprocessor_args.join(" ")
reference_reader_args = reference_reader_args.join(" ")
input_preprocessor_args = input_preprocessor_args.join(" ")
input_reader_args = input_reader_args.join(" ")
-%>

# Execute registration pipeline ----------------------------------------------------------------
command="singularity run -B ${BF_FORMAT_F}:/root/.local/lib/python3.12/site-packages/valis/data/bf_formats.txt ${VALIS_CONTAINER}\
 -s ${REFERENCE_BASENAME} -t ${TEMP_DIR} -o ${OUTPUT_DIR}\
 -r ${REFERENCE_FILENAME}\
 -rp <%= context.reference_image_preprocessor %> <%= reference_preprocessor_args %>\
 -rr <%= context.reference_image_reader %> <%= reference_reader_args %>\
 -i ${INPUT_FILENAME}\
 -ip <%= context.input_image_preprocessor %> <%= input_preprocessor_args %>\
 -ir <%= context.input_image_reader %> <%= input_reader_args %>\
 -mp ${PROCESSING_SIZE}\
 -c ${CODEC} -cq ${QUALITY}\
 -y"

echo "$command"
#eval "$command"

echo "TIMING - Finished Image Registration at: $(date)"
